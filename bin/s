#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Try to run http.server. Default port is 8000.
If 8000 is in use, use 8001...
"""

import socket
import socket
import errno
from http.server import HTTPServer, SimpleHTTPRequestHandler

__author__ = "Frank Xu"
__copyright__ = "Copyright 2019. Frank Xu"
__credits__ = ["Frank Xu"]
__license__ = "WTFP 2.0"
__version__ = "0.1.0"
__maintainer__ = "Frank Xu"
__email__ = "frank@frankxu.me"
__status__ = "Dev"


def get_lan_ip():
    """
    https://www.w3resource.com/python-exercises/python-basic-exercise-55.php
    """
    return [l for l in ([ip for ip in socket.gethostbyname_ex(socket.gethostname())[2]
                         if not ip.startswith("127.")][:1], [[(s.connect(('8.8.8.8', 53)), s.getsockname()[0], s.close())
                                                              for s in [socket.socket(socket.AF_INET, socket.SOCK_DGRAM)]][0][1]]) if l][0][0]


def main():
    ip = get_lan_ip()
    port = 8000
    while port < 8010:
        try:
            httpd = HTTPServer((ip, port), SimpleHTTPRequestHandler)
            print("Running http server at {0}:{1}".format(ip, port))
            httpd.serve_forever()
        except socket.error as e:
            if e.errno == errno.EADDRINUSE:
                inuse_port = port
                port += 1
                print("Port '{}' is already in use. Try new port '{}'".format(inuse_port, port))
                continue
            else:
                print(e)
                break

if __name__ == '__main__':
    main()
